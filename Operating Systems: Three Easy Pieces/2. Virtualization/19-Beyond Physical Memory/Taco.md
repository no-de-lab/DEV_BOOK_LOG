만약 주소 공간이 커서 물리적 메모리에 전부 올릴 수 없다면, 메모리에 우선 순위를 둘 수밖에 없다. 
즉 메모리 계층이 필욯다. 
현재 사용하지 않는 주소공간이라면, stash한다. 즉 조금 느려질 수는 있겠다. 현대 시스템에서 그를 보통 hdd에 저장해둔다. 

그렇다면 어떻게 큰 가상 메모리가 있는 척을 해볼 수 있을까? 
이렇게 해야하는 이유는 편리하기도 하고, 사용이 쉽기도 하기 때문이다. 매모리 공간을 신경쓸 필요가 없으므로 그냥 코드에 집중하면 되기 때문이다.

가상 메모리가 큰 척을 하기 위해서는, 
- swap space가 큰 역할을 한다. 
- 아무래도 이는 멀티 프로그래밍과 쉽게 사용하려는 욕구 모두가 결합되어서 일어난 일일 것이다.

## Swap Space
disk에 해당 공간을 좀 남겨둔다. OS가 페이지 단위로 swap 공간을 읽고 쓸 수 있다. 
이 스왑 공간의 사이즈는 주어진 시간 안에 시스템이 사용 가능한 메모리 페이지의 최대치를 말하기 때문에 중요하다. 

근데 스왑 공간은 단순히 디스크에 있는 것만은 아니다. code page는 처음에는 디스크에 있지만, 프로그램이 시작하면, 메모리에 로드된다.

## The present bit
돌아가고 있는 프로세스는 가상 메모리 레퍼런스를 만들어내고, 하드웨어가 그를 물리적 주소로 바꾼다. 
이 과정에서 tlb도 사용하고 tlb에 만약 가상 주소가 없다면, 페이지 매핑을 시작한다.

그런데, 만약 디스크에 페이지가 스왑되길 바란다면 우리는 다른 bit를 추가해야한다. 그것이 바로 present bit다. 이것이 1이면 물리메모리에 있다는 뜻이고 아니라면 디스크 어딘가에 있는 것이다. 
물리적 메모리에 없는 페이지에 접근하는 것은 page fault라고도 불린다. 이 경우 OS가 해결하기 위하여 등장한다. 

## Page Fault
hardware tlb, sw tlb 모두 페이지 fault가 나면 os에 기대게된다. os는 페이지 테이블을 보고, 메모리에 올린다. 이 disk i/o가 끝나면 os는 페이지 테이블을 업데이트 하게 된다. 
이렇게 i/o가 진행될 때 프로세스는 대기 상태에 있다. 그러므로 os는 페이지 다른 준비 상태의 프로세스를 돌릴 수도 잇다. i/o 과정이 비용이 많이 들기 때문에 하나의 i/o동안 다른 프로세스의 실행은 효과적이다. 

## What If Memory Is full?
memory가 부족하면 페이지를 메모리에서 빼와야하는데, 그를 replace라 하고 이를 효율적으로 계획하여 실행하여야한다.

## Page Fault Control Flow
hardware, os의 방향이 서로 다르다. 
- 하드웨어: 
  - 만약 tlb 미스가 난다면, 세가지 케이스로 바라볼 수 있다.
    - 하나는 present, valid 비트가 모두 1일 경우: 이 경우는 한번 더 시도해서, tlb miss handler가 tlb에 등록해주어 다음 시도에는 tlb hit이 난다. 
    - 둘째는 page fault handler가 작동해야한다. present bit 0 이라. 
    - 셋째는 invalid page라서, (버그가 있는것) 하드웨어는 트랩을 발생시킨다. 
- OS:
  - physical frame을 찾아내어, 어떻게 replace할지 고민한다. 
  - 물리메모리 프레임을 가지고, 핸들러는 i/o 요청을 보내어서 스왑 공간에서 페이지를 읽어오게 한다. 
  - 작업이 끝나면 페이지 테이블을 업데이트한다.

## When Replacements Really Occur
os가 조금은 free 메모리를 남겨두어야한다.
그를 위하여, high watermark, low watermark를 두어 매ㅔ모리로부터 페이지를 쫓아낼 때가 언제일지를 결정하게끔 돕는다. 

lw 페이지보다 적을 때, background thread가 작동해서 hw page가 사용 가능해질 때까지 페이지를 쫓아낸다. 이 background thread는 swap daemon, page daemon이라고도 불린다. 
replacement를 바로 진행하는 것이 아니라, 알고리듬은 어떤 free page가있는지 체크해야한다. 
없으면, background paging thread에 알린다. 

