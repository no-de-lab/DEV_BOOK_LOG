키-값 데이터베이스라고도 불리는 키-값 저장소는 고유 식별자를 키로 가진다. 이 키는 일반 텍스트일 수도 있고, 해시 값일수도 있다. 값은 문자열일 수도 있고 리스트일수도 잇고 객체일수도 있다.

## 단일 서버 키-값 저장소
가장 직관적으로는 키-값 쌍 전부를 메모리에 해시 테이블로 저장하는 것이다. 그러나 이는 모든 데이터를 메모리 안에 두는 것이 불가능할 수 있다는 약점이 있다. 
- 데이터 압축
- 캐시 
와 같은 방법으로 개선할 수는 있지만, 한 대 서버로 부족하다. 

## 분산 키-값 저장소
단일 서버를 보완하기 위해 분산 키-값 저장소를 사용한다. 
그런데 이는 CAP 정리를 이해해야 한다. 

### CAP 
- Consistency: 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했는지와 관계 없이 언제나 같은 데이터를 보게되어야 한다.
- Availability: 분산 시스템의 클라이언트는 일부 노드에 장애가 발생해도 항상 응답을 받을 수 있어야 한다. 
- Partition Tolerance: 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여야한다.

그런데 이 세가지를 모두 충족하기 어렵다. 
- CP 시스템: 가용성을 희생한다. 문제가 생길 경우, 쓰기 연산을 중단 시킨다. 
- AP 시스템: 일관성을 희생한다. 낡은 데이터를 반환할 위험이 있더라도 계속 파티션이 발생한 네트워크에 읽기 연산을 허용하여야한다. 또한 파티션이 발생하지 않은 서버의 경우 쓰기 연산도 허용한다. 
- CA 시스템: 파티션이 생기지 않는건 가능하지 않으므로 실세계에 CA 시스템은 조재하지 않는다. 

## 키 값 저장소 구현에 사용될 핵심 컴포넌트
- 데이터 파티션: 안정해시를 통해, 데이터를 여러 서버에 고르게 분산하고 노드가 추가/삭제될 때 데이터의 이동을 최소화할 수 있다.
- 데이터 다중화: 높은 가용성과 안정성을 확보하기 위해, 데이터를 N개 서버에 비동기적으로 다중화할 필요가 있다. 해시 링 위에 키를 배치하고 그 지점으로부터 만나는 N개 서버에 데이터 사본을 보관한다. 
- 데이터 일관성: 여러 노드에 다중화된 데이터는 적절히 동기화가 되어야한다. 정족수 합의 프로토콜로 이를 보장할 수 있다. 이에는 몇가지 값들이 영향을 미친다
    - N= 사본 개수
    - W = 쓰기 연산에 대한 정족수
    - R = 읽기 연산에 대한 정족수
    - 이 값을 정하는 것은, 응답 지연과 데이터 일관성 사이의 타협점을 찾는 과정이다. 
    - W+R > N이면, 강한 일관성이 보장된다. 
    - W=1, R=N이면 빠른 쓰기 연산, 반대면 빠른 읽기 연산에 최적화된 시스템이다. 
- 일관성 모델: 데이터 일관성 수준을 결정하는데, 종류가 다양하다.
    - 강한 일관성 모델: 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환한다. 
    - 약한 일관성 모델: 읽기 연산은 가장 최근에 갱신된 결과를 반환할 수 없을수도 있다.
    - 최종 일관성 모델: 약한 일관성의 한 형태. 갱신 결과가 결국 모든 사본에 반영되는 모델이다.
- 비 일관성 해소 기법: 데이터 버저닝-> 데이터 다중화하면 일관성이 깨질 가능성이 높아지므로, 데이터 변경시마다 해당 데이터의 새 버전을 만든다. 버저닝 시스템을 만들어 낼 때에, 벡터 시계를 통해 이를 해결한다. 만일 데이터 D를 서버 Si에 기록하면, [Si, vi]가 있으면 vi를 증가시키고, 아니면 새 항목을 만든다. 이를 이용해 충돌여부를 확인하고, 한 벡터 시계 구성요소 가운데 다른 벡터 시계 동일 서버 구성요소보다 작은 값을 가지는 것이 있는지 확인한다. 

그러나 이 방법은 클라이언트가 충돌을 감지하고 해소해야하므로 구현이 복잡해지고, 순서쌍 개수가 빨리 늘어난다는 문제가 있다. 

- 장애 감지와 장애 해소: 한 대 서버가 죽은지 확인하는 방법은 두대 이상의 서버가 보고를 하는 것이다. 멀티 캐스팅으로 다 연결되어있으면 비효율적이라, 가십 프로토콜같은 솔루션을 채택한다. 각 노드는 주기적으로 박동 카운터를 증가시키고, 무작위로 선정된 노드들에 그 목록을 보낸다. 그 목록을 받은 노드는 최신값으로 갱신하되, 어떤 멤버의 카운터가 지정된 시간 동안 갱신되지 않으면 해당 멤버는 장애 상태로 간주한다. 

이를 처리하려면 임시 장애일 경우, 몇 정상 서버가 오류 서버의 일을 위임받아 해결하고, 영구 장애일 경우 반-엔트로피 프로토콜로 사본들을 동기화 한다. 이는 머클 트리라는 것을 만들어서, 루트에서부터 서버 해시값을 읽는다. 일치하면 데이터 변경이 없던 것이고, 다르다면 데이터 변경이 있는 것이므로 아래쪽으로 탐색해나가며 다른 데이터를 가지는 버킷만 동기화한다. 