대규모 알람 시스템을 구축하기 위해, 
1. 알림 유형별 지원 방안
2. 연락처 정보 수집 절차
3. 알림 전송 및 수신 절차를 설계해야한다.

### 알림 유형별 매커니즘
1. iOS 푸시 알림: 아래 세 가지 컴포넌트가 필요하다. 
    - 알림 제공자, 알림 주체다. (단말 토큰과 페이로드->알림 내용이 필요하다.)
    - APNS: 애플의 원격 서비스다. 푸시 알림을 iOS 장치로 보내는 역할을 담당한다.
    - iOS 단말
2. 안드로이드 푸시 알림: iOS와 비슷하지만 APNS 가 아닌, FCM을 사용한다 (firebase cloud messaging)
3. SMS 메시지: 트윌리오나 넥스모 같은 제 3 사업자의 서비스를 많이들 이용한다. 
4. 이메일: 센드그리드나 메일침프와 같이 전송성공률도 높고 데이터 분석 서비스를 제공하는 상용 이메일 서비스를 많이들 이용하다. 

### 연락처 정보 수집 절차
- 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다. 
- 사용자가 우리 앱을 설치하거나 처음으로 계정을 등록하게 되면 api 서버는 해당 사용자의 정보를 수집해 데이터 베이스에 저장한다.
- user table, device table을 서로 연결한 형태다.

### 알림 전송 및 수신 절차
여러 서비스가 알림 시스템(1개)을 이용해서 제 3자 서비스인 (apns, fcm, sms, email 서비스)들을 통한 알림을 제공할수가 있다. 그러나 이는 SPOF 문제가 있고, 한대 서비스로 이리저리 확장하기 어렵다. 또한 성능 병목이 있다. 

따라서 알림 서버에서 데이터베이스와 캐시를 주 서버에서 분리한다. 알림 서버를 증설한다. 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다. 

## 상세 설계
### 안정성
- 데이터 손실 방지: 어떤 상황에서도 알림이 소실되면 안된다. 이를 위해서는 알림 데이터를 데이터 베이스에 보관하고 재시도 매커니즘을 구현해야한다. 
- 알림 중복 전송 방지: 중복을 완전히 없앨 수 없을수 있지만, 빈도를 줄이려면 중복 탐지 매커니즘을 도입하고 오류를 신중히 처리해야한다. 예를 들면 보내야 할 알림이 있을 때 이벤트 아이디를 검사해서 이전에 본 이벤트인지 살핀다. 중복되었다면 버리고 그렇지 않다면 알림을 발송한다.

### 추가로 필요한 컴포넌트 및 고려사항
- 알림 템플릿: 알림 메시지 대부분은 형식이 비슷하므로 템플릿을 사용한다.
- 알림 설정:사용자가 알림 설정을 상세히 조정할 수 있게 하여, 특정 종류의 알림을 보내기 전에 반드시 테이블을 확인한다.
- 전송률 제한:알림의 빈도를 제한한다.
- 재시도 방법: 알림 전송에 실패하면 재시도 전용 큐에 넣는다. 같은 문제가 계속해서 발생하면 개발자에 통지한다.
- 푸시 알림과 보안: 인증된 클라이언트만 알림을 보낼 수 있다. 알림 전송 api는 appKey, appSecret을 사용해야한다.
- 큐 모니터링: 큐에 쌓인 알림의 개수를 확인하여 너무 크면 작업서버를 증설한다.
- 이벤트 추적: 분석 서비스와도 통합해서 메트릭을 이해한다. 