### 웹서버 

#### 01 클라이언트 커넥션 수락 
- 새 커넥션 다루기 
  - TCP 커넥션에서 IP주소를 추출하여 클라이언트 확인
  - 새 커넥션이 맺어지면 커넥션 목록에 추가하고 커넥션에 오고가는 데이터를 지켜볼 준비
  - 어떤 커넥션이든 거절 또는 닫을 수 있음
- 클라이언트 호스트 명 식별
  - 역방향 DNS를 사용하여 클라이언트 IP 주소를 클라이언트 호스트명으로 변환 하도록 설정
  - 호스트 명 룩업은 꽤 시간을 소요하여, 웹 트랜잭션을 느려지게 할 수 있음
  - 보통 호스트명 분석을 꺼두거나 특정 콘텐츠에 대해서만 활성화
- ident를 통해 클라이언트 사용자 알아내기
  - IETF ident 프로토콜 지원
  - 어떤 사용자 이름이 HTTP 커넥션을 초기화 했는지 찾아낼 수 있게 해줌
  - 웹 서버 로깅에 유용
  - 클라이언트가 지원할 경우 TCP포츠 113번을 listen
  - ident는 조직 내부에서는 잘 사용하지만, 공공 인터넷에서는 작동하지 않음 
    - ident 신원확인 프로토콜 데몬을 실행하지 않음
    - 트랜잭션 지연
    - 방화벽이 막는 경우
    - ident 프로토콜 안전하지 않고 조작 쉬움
    - 클라이언트 사용자 노출로 인한 프라이버시 침해 우려


#### 02 요청 메세지 수신
  - 메세지의 내부 표현  
  웹 서버는 파싱한 요청 메시지를 쉽게 다룰 수 있도록 내부의 자료 구조에 저장한다.
    - 파싱된 데이터에 대한 포인터와 길이를 담는다.
    - 헤더는 룩업 테이블에 저장되어 각 필드에 빠르게 접근할 수 있다.
  - _커넥션 입력/출력 처리 아키텍처_
    - 싱글 스레드 웹 서버
      - 한 번에 하나씩 요청 처리, 다음 커넥션 처리
      - 하나의 트랜잭션 처리 중, 다른 요청은 무시되므로 서비스의 성능 문제가 생긴다.
    - 멀티 프로세스와 멀티 스레드 웹 서버
      - 여러 프로세스와 스레드가 있기 때문에, 여러 요청을 동시에 처리할 수 있다.
      - 스레드는 필요할 때마다 생기거나 스레드 풀(Thread Pool)에서 가져와서 요청에 할당할 수 있다.
      - 무분별한 프로세스와 스레드로 발생하는 리소시 낭비를 막기 위해 최대 스레드와 프로세스 수 제한
    - 다중 I/O 서버
      - 많은 웹 서버가 다중 I/O 서버 채택
      - 모든 커넥션이 동시에 활동이 감시됨
      - 커넥션 상태가 바뀌면, 그 커넥션에 대해 작은양의 처리가 수행됨
      - 커넥션에 일이 할당될 때 커넥션에 대한 작업 수행
    - 다중 멀티스레드 웹 서버
      - 멀티 스레딩과 다중화(멀티 플렉싱)를 결합한 웹 서버
      - 여러 개의 스레드는 커넥션의 부분집합을 감시하고, 변경이 일어나면 작업을 수행한다.

#### 03 요청 처리
  - HTTP 요청 메시지에서 method, resource, header, body를 얻어내서 처리


#### 04 리소스의 매핑과 접근
_웹 서버는 리소스 서버이다._  
정적 컨텐츠 제공 : HTML 문서나 이미지 같은 미리 만들어진 컨텐츠 제공  
동적 컨텐츠 제공 : 웹 애플리케이션 서버를 통해 동적 컨텐츠를 만들어서 제공
  - docroot로 클라이언트가 요청한 URI에 맞는 리소스를 서버에서 어떻게 찾는다 


#### 05 응답만들기
리소스 식별하면, 서버는 요청 메서드로 서술되는 동작 수행 후, 응답 메세지를 반환한다. 
  - 1.응답 엔티티
    - MIME 타입을 서술하는 Content-Type 헤더
    - 응답 본문의 길이를 서술하는 Content-Length 헤더
  - 2.MIME 타입 결정하기
    - mime.types(가장 흔한 방법)
      - 파일 이름의 확장자를 사용
      - 확장자별 MIME 타입이 담겨있는 파일을 탐색
    - 매직 타이핑
      - 파일의 내용을 검사해서 매직 파일(알려진 패턴에 대한 테이블)에 해당하는 패턴을 찾아 타입을 정함
      - 파일이 표준 확장자 이름 없이 지어진 경우에 유용함.
    - 유형 명시
      - 파일 확장자와 관계 없이, 특정 파일이나 디렉토리 내의 파일에 대한 MIME 타입을 지정
    - 유형 협상
      - 한 리소스가 여러 종류의 MIME에 속하도록 설정
  - 3.리다이렉션  
    메세지 대신 리다이렉션 응답을 반환할 경우
    3XX 상태코드로 지칭함
    - 리소스가 영구적으로 옮겨진 경우 (301 Moved Permanently)
    - 임시로 리소스가 옮겨진 경우 (303 See Other, 307 Temporary Redirect)
    - URL 증강
      - 문맥 정보를 포함시키기 위해 재 작성된 URL로 리다이렉트
      - 서버는 상태 정보를 내포한 새 URL을 생성
      - 303 See Other, 307 Temporary Redirect
    - 부하 균형(Load Balancing)
      - 과부화된 서버가 요청을 받으면, 덜 부하가 걸린 서버로 리다이렉트
    - 친밀한 다른 서버가 있을 때
      - 웹 서버가 클라이언트에 대한 정보를 갖고 있을 수 있음
      - 요청한 클라이언트에 대한 정보를 갖고 있는 다른 서버로 리다이렉트
    - 디렉토리 이름 정규화
      - 클라이언트가 디렉토리 이름에 대한 URI를 요청하는데, 슬래쉬를 빠뜨렸다면 슬래쉬를 추가한 URI로 리다이렉트      

#### 06 응답보내기
비지속적 커넥션 : 서버는 데이터 전송 후, 커넥션 닫음  
지속적 커넥션 : 데이터 전송 후 커넥션 유지
#### 07 로깅
트랜잭션 완료 후 어떻게 트랜잭션이 수행되었는지를 로그 파일에 기록
