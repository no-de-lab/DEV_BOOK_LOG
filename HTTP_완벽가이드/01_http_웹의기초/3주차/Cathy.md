### 4장 커넥션 관리

#### TCP 커넥션
HTTP 통신은 패킷교환 네트워크 프로토콜들의 계층화된 집합인 TCP/IP를 통해 이루어진다. 클라이언트와 서버는 TCP/IP 커넥션을 맺을 수 있고, 맺어지면 HTTP 메세지들은 안전하게 전달된다.


#### TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송된다.

TCP는 데이터를 전송할 때 바이트를 기본단위로 사용자 데이터를 스트림 형태로 처리한다. _(스트림 전송서비스는 전송지에서의 데이터 순서가 최종 수신지에서도 일치되도록 한다는 의미다. 이것이 TCP의 스트림 지향성(Stream Orientation)이다.)_

TCP는 세그먼트라는 단위로 데이터 스트림을 잘게 나누고, 세그먼트를 IP 패킷이라고 불리는 봉투에 담아서 인터넷을 통해 데이터를 전달한다. 이 모든것은 TCP/IP 프로그래멩에 의해 처리됨  
각 TCP 세그먼트는 하나의 IP 주소에서 다른 IP주소로 ip 패킷에 담겨 전달한다. 


#### TCP 커넥션 유지하기
컴퓨터는 항상 여러개의 TCP 커넥션을 가지고 있다. TCP는 포트 번호를 통해서 여러개의 커넥션을 유지 _(포트 번호는 회사 직원의 내선전화와 비슷하다)_  

TCP 커넥션 네가지 값으로 구성, 네가지 구성요소가의 값이 모두 같을 수 없음
<발신지 IP주소, 포트, 수신지 IP주소, 포트>  

#### TCP 소켓 프로그래밍
네트워크와 접속하게 해주는 역할을 한다.
데이터를 주고받을 수 있게 해주는 구조체, 데이터 통로가 만들어 진다. _(WebSocket 을 조금 더 이해할 수 있겠군...?)_

클라이언트 소켓의 흐름
- 소켓 생성 - socket()
- 서버 측에 연결 - connect()
- 서버 소켓에서 연결을 받으면 데이터를 송수신 - send() / recv()
- 모든 처리가 완료되면 소켓을 닫음 - close()

서버측 소켓의 흐름
- 소켓 생성 - socket()
- 서버가 사용할 IP 주소와 포트 번호를 생성한 소켓에 결합 - bind()
- 클라이언트로부터 연결 유청이 수신되는지 주시 - listen()
- 요청이 수신되면 accpet 후 요청 처리 - accept()
- 데이터 송수신 - send() / recv()
- 소켓 닫음 - close()


#### TCP 성능에 대한 고려
HTTP는 TCP 성능에 영향을 받는다. 

HTTP 트랜잭션 지연시키는 원인
- URI 호스트 명을 IP 주소로 변환에 시간소요
- 커넥션 설정에 소요되는 시간
- 요청/응답 메세지를 처리하는 시간
- 서버가 HTTP 응답을 보내는 시간


성능 관련 중요요소
- TCP 커넥션 핸드셰이크설정
  - ACK 패킷은 HTTP 요청 메시지 전체(IP 패킷은 인터넷상에서 수백 바이트이다)를 전달할 수 있을 만큼 큰 경우가 많다.
  - 때문에 크기가 작은 HTTP 트랜잭션은 50%이상의 시간을 TCP를 구성하는데 사용
  - 지연을 해결하기 위해, 커넥션을 재활용이 필요
- 확인응답 지연
  - 송출 데이터 패킷과 확인응답을 하나로 묶어 네트워크를 효율적으로 사용
  - 각 TCP 세그먼트는 순번과 데이터 무결성 체크섬을 가진다
  - 확인응답은 그 크기가 작아, TCP는 같은 방향으로 송출되는 데이터 패킷에 확인응답을 '편승(piggyback)
  - 송출할 확인응답을 특정 시간(0.1s~0.2s)동안 버퍼에 저장해 두고, 편승시킬 패킷을 찾음
- TCP의 느린시작
  - 처음에는 커넥션의 최대 속도를 제한
  - 시간이 지나면서 속도 제한을 높임
  - 스스로 튜닝함 -> 튜닝된 커넥션
  - 그래서 커넥션 재활용 필요
- 네이글 알고리즘
  - 작은 크기의 데이터를 포함한 많은 수의 패킷을 전송한다면 네트워크 성능은 크게 떨어진다.
  - 네트워크 효율을 위해서, 패킷을 전송하기 전에 많은 양의 TCP 데이터를 한 개의 덩이로 합친다
  - (문제점) 세그먼트가 최대ㅑ크기가 되지 않으면 전송하지 않기 때문에, 패킷이 채워지지 않으면 지연됨.
  - (문제점) 황인 응답이 도착할 때까지 데이터 전송을 멈추는데 확인응답 지연 은 확인 응답을 100~200밀리초 지연시키기 때문에 함께 사용하면 성능을 저하시킨다.
- TIME_WAIT누적과 포트 고갈
  - 같은 주소와 포트 번호를 사용하는 새로운 TCP 커넥션이 일정 시간 동안에 생성되지 않도록 하는 것
  - 이전 커넥션과 관련된 패킷이 새로운 커넥션에 삽입되는 문제를 방지



#### 커넥션관리 
- 병렬 커넥션
  - 여러 개의 TCP 커넥션을 통한 동시에 HTTP 트랜잭션을 병렬로 처리
  - 각 커넥션의 지연 시간을 겹치게 하여 총 지연 시간을 줄일 수 있음
  - 인터넷 대역폭을 한 개의 커넥션이 다 쓰는 것이 아니라 나머지 객체를 내려받는 데에  사용할 수 있음
  - 네트워크 대역폭이 좁다면, 성능상의 장점은 거의 없음
- 지속 커넥션
  - 처리가 완료된 이후에도 연결된 상태로 있는 TCP 커넥션을 유지해 HTTP 요청에 재사용'
  - 사전 작업과 지연 줄어들고, '튜닝'된 커넥션 사용
  - 지속성 & 병렬이 함께 사용되면 성능 개선가 가장 효과적
- 파이프라인 커넥션
  - 공유 TCP 커넥션으로 병렬 HTTP 요청
  - HTTP/1.1은 지속 커넥션을 통해서 요청을 파이프 라이닝 할 수 있다. (실행중인 명령이 끝나기 전에 다른 명령의 실행을 시작한다.)

#### 커넥션 끊기
전체 끊기, 절반 끊기
전체 끊기 : close()를 호출하면 입, 출력 채널의 커넥션이 모두 끊어진다.
절반 끊기 : shutdown()을 호출한다. (우아...한?)

----- 

프로토콜 스택

>HTTP - 어플리케이션 계층  
TCP - 전송 계층  
IP - 네트워크 계층  
Network Interfaces - 데이터 링크 계층  

>HTTPS - 어플리케이션 계층  
TLS 혹은 SSL - 보안 계층  
TCP - 전송 계층  
IP - 네트워크 계층  
Network Interfaces - 데이터 링크 계층  

Ip packet

>Ip packet header 20byte - ip 주소, 크기 , 기타 플래그  
Tcp segment header 20byte - 티씨피 포트번호 제어플래그, 숫자값(데이터 순서와 무결성 검사를 위해)  
tcp data piece 0 ~   


---
#### 참고

- [TCP 특성](https://physicallaw.tistory.com/112#:~:text=TCP%EB%8A%94%20%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%A5%BC%20%EC%A0%84%EC%86%A1%ED%95%A0,%EC%A7%80%ED%96%A5%EC%84%B1(Stream%20Orientation)%EC%9D%B4%EB%8B%A4.)


- [소켓과 소켓 프로그래밍 개념](https://velog.io/@devsh/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EA%B8%B0%EC%B4%88-%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC%ED%95%98%EA%B8%B0-%EC%86%8C%EC%BC%93%EA%B3%BC-%EC%86%8C%EC%BC%93-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EA%B0%9C%EB%85%90)