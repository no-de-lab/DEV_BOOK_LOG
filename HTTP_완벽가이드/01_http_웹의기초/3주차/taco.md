## TCP가 이 책에서 가지는 의미
어떠한 요청과 응답을 온전하게 가져가기 위해서는, TCP 통신이 없어서는 안된다.
HTTP 통신을 위해서는 HTTP의 커넥션을 이해하고 있어야 하기 때문이다.
HTTP 커넥션의 작은 의미 : TCP 통신

> 우리는, TCP/IP 커넥션 덕분에 메세지의 손상 없이 안전하게 소통할 수 있다.
> HTTP 커넥션은 몇몇을 제외하고는 TCP 커넥션이다

## TCP 커넥션이 작용하는 방식
TCP는 한번에 데이터를 다 갖다 보낼 수가 없으니, 조금씩 잘라서 조금 조금씩 보내기로 한다. 
TCP는 세그먼트라는 단위로 데이터를 나눠, 이를 IP 패킷에 담아 보낸다.
> OSI7계층에서는 전송 계층에서 TCP 세그먼트를 네트워크 계층에서 IP 패킷으로 감싼다고 표현한다.
- IP 패킷은, IP 패킷 헤더(20byte) + TCP 세그먼트 헤더(20byte+) + 데이터 조각을 포함한다.
- TCP는 커넥션을 생성할 때, IP주소들과 포트 주소들이 필요하다.
- 그럼 각 패킷마다 40-60 byte
- IP 패킷에는 IP 주소에 관한 정보가, TCP 세그먼트에는 포트에 관한 정보가 들어있다.
- 이러한 커넥션은 소켓으로 가능하다. 소켓을 통해 TCP나 IP의 세부사항을 숨길 수 있다. 

## TCP의 성능도 중요하다.
### HTTP 트랜잭션 처리 시간은 상대적으로 짧다. 대부분은 TCP의 성능과 관계가 있다.
- TCP가 연결되는 과정에서 그리 크지않은 트랜잭션인데도, 핸드셰이크를 위해 SYN, ACK 플래그를 포함하는 TCP 패킷을 주고받아 지연을 일으킨다.
- TCP 자체적으로 세그먼트 수신을 했을 때 확인 응답 패킷을 송출 데이터 패킷에 편승해서 보내는데, 문제는 특정시간동안 해당 패킷을 찾느라 시간을 쓰는 것. 생각보다 많은 송출 패킷이 없기에, 결국 속도가 느려진다.
- TCP 커넥션은 처음에는 속도 제한을 둔다. 이때문에 확인 응답을 몇번 받으면 더 많이 보낼 수 있도록 허락받는 느린 시작을 하게된다.
- 세그먼트는 하나에 40바이트 정도 되기 때문에, 최대 크기가 되었을 때 전송을 하게 하는 (한번에) 네이글 알고리즘을 사용한다. 확인 응답을 받으면 더 작은 패킷도 보낼 수 있지만, 너무 느려진다.
- TCP 연결을 끊을 때, IP/포트주소를 제어영역에 기록하고 한동안 (2MSL) 해당 연결을 막아놓는데, 이는 어느정도 같은 패킷이 새로운 커넥션에 연결되지 않게하기위함이다. 성능문제를 할 때는 포트만 바꿀 수 있으므로 커넥션이 제한되고 포트 고갈 문제가 생긴다.

## HTTP 커넥션은 어떻게 관리하는지? 
TCP 연결에서 주의해야할 점은 알겠는데, 그보다 큰 단위의 http 커넥션 관리도 중요하다.

순차적 처리를 하게될시, 모든 요소에 대하여 각각 연결-끊기를 진행하여 큰 지연을 느끼게될 수 있다.
따라서 이 성능을 향상시키려고,
- 병렬/지속/파이프라인/다중 커넥션 등이 이용된다.
- 병렬은 여러 TCP 연결을 통해 병렬적으로 객체를 로드한다.
- 병렬은 성능을 떨어트릴 위험 때문에 최대 4개 정도의 커넥션이 허용된다

그러나 병렬 커넥션은, 불필요한 트랜잭션 시간이나 TCP 지연 등의 문제를 여전히 안고있어 이를 지속적으로 연결하게끔 도와주는
지속 커넥션이 함께 사용되었을 때 효과적이다.

- keep-alive를 통해 지속 커넥션을 유지한다.
- Connection 헤더 이용
- 무조건적인 것은 아니다. 
- keep-alive는 멍청한 프록시에서 사용되었을 때 클라이언트로 하여금 프록시와 서버 사이를 끼어들지 못하게한다.
- http 1.1에서는 keep-alive가 사용되지 않는다. 대신 기본으로 지속 커넥션이 활성화됐다.
- Connection: close를 통해 연결을 끊을 수 있다 (http 1.1)
- 그러나 그렇다고 해서 영원히 연결이 지속되는 것은 아니다..

HTTP 1.1의 지속 커넥션을 통해 파이프라인 커넥션을 만들어낼 수도 있다. 
요청이 연속적으로 응답이 오기 전에 시행되는 것을 파이프라인 커넥션이라고 한다. 
다만 요청 순서대로 응답 순서가 구성되어있어야 한다거나, 언제든지 다시 요청을 보낼 수 있을 준비가 되어야 한다. 
또한 재차 보내도 응답이 똑같은 요청만 보내야한다 (멱등성 중요)

## 그렇다면 연결을 끊는 방법은? 
명확한 기준이 없다. 다만 끊을 때를 대비하여 언제나 준비가 되어있어야한다. 

- 보통은 전체 끊기만 사용하나, 예상치못한 에러가 있을 때를 대비해 절반끊기를 사용해야한다. 
- 또한 출력 채널에 절반 끊기를 하는 것이 안전하다. 
- 입력에서 끊기를 하게 된다면, connection reset by peer 메세지가 도착하고,이미 응답 받은 데이터가 있음에도 모두 삭제된다. 
- 일반적으로는 먼저 출력 채널을 끊고, 반대편의 출력 채널이 끊기는 것을 기대해야한다. 
