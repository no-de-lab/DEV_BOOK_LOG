# 20. 리다이렉션과 부하 균형

리다이렉션이란 최적의 분산된 콘텐츠를 찾는 것을 도와주는 기법
  - 본질은 그런 것 이었구나

리다이렉션 구현에는 부하 균형의 과제가 포함되는데, 대부분의 리다이렉션 장치들은 몇 가지 방식의 부하 균형을 포함 한다. 

_서버, 프락시, 캐시, 게이트웨이_ 는 클라 입장(HTTP 요청을 보내고 그것을 처리한다는 것)에서 모두 서버라고 할 수 있다. 
모두 공통적으로 서버의 특성르 갖고 있기에 많은 리다이렉션 기법이 그들 모두에게 동작한다. 
웹 서버는 IP별로 요청을 다룸 -> 서버로의 리다이렉트란 휘발유를 찾는 모든 운전기사를 가장 가까운 주유소로 보내주는 것
프락시는 프로토콜별로 요청을 다룸 -> 프락시로의 리다이렉트는 주 진입로의 트래픽을 근처에있는 지름길로 빨아들이는 것

리다이렉션의 목표는 HTTP 메세지를 가용한 웹 서버로 가급적 빨리 보내는 것 
브라우저 설정, DNS, TCP/IP 라우팅, 그리고 HTTP는 모두 메시지를 리다이렉트하는 메커니즘 제공

일반 리다이렉션 방법
대부분 기법들이 트래픽을 보내려는 곳이 어떤 서버냐에 상관없이 사용될 수 있음
- HTTP 리다이렉션
  요청을 처리하는 서버는 가용한 것들 중 부하가 가장 적은 콘텐츠 서버를 찾아서 브라우저의 요청을 그 서버로 리다이렉트
  - 웹 서버들이 광범위하게 분산되어 있다면 '최선의' 가용한 서버를 결정하는 것이 어려움
  - 페이지 접급할 때마다 두번의 왕복이 필요 -> 느림
  - 리다이렉트 서버가 에러 -> 사이트 에러 
  - 다른 기법과 조합하여 사용됨
- DNS 리다이렉션
  도메인 이름 반드시 IP주소로 분석 -> DNS는 하나의 도메인에 여러 아이피 주소가 결부 되는 것 허용, 여러개의 IP 중 어떤것에 돌려줄 지 결정해야한다
  - DNS 라운드 로빈 (DNS 결정 알고리즘)
    - 가장 흔하고 단순한 리다이렉션 기법
    - DNS 호스트 명 분석 기능을 사용 -> 순수한 부하 균형 전략
    - 서버에 대한 클라이언트의 상대적 위치 / 서버의 스트레스 고려 하지 앟음
    - 대부분의 DNS 클라이언트는 다중 주소 집합의 첫번째 주소 사용하고 룩업이 끝나고 주소를 순환하여 부하균형을 맞춤 -> DNS 라운드 로빈
    - 캐시 때문에 하나의 클라이언트로 인한 부하를 재대로 분산 못함 (한번 쓴 ip를 계속해서 사용)
- 임의 캐스팅 어드레싱
  여러 지리적으로 흩어진 웹 서버들은 같은 IP를 갖는 클라 요청을 가장 가까운 서버로 보내기 위해 백본 라우터의 '최단거리' 라우팅 능력에 의지
  백본 라우터가 임의 캐스트 주소를 목적지로 하는 패킷을 받았을때 가장 가까운 라우터(가까운 서버) 찾아 패킷 전송

  > Anycast IP는 서로 다른 곳, 서로 다른 호스트 끼리 동일한 IP주소를 가질 수 있는 개념
  > 2003년 1.25 인터넷 대란때 5개의 root DNS가 웜으로 DDoS공격당하여 전세계 DNS가 마비되어서 개선안으로 Anycast 기술을 사용하게 됨
  > Anycast IP를 이용하여 DNS를 적절히 분산구성하여 한쪽 지역이 무너지더라도 다른 지역에서 서비스를 받을 수 있음

  > 백본(backbone) 라우터는 네트워크의 서로 다른 메시에있는 별도의 시스템을 서로 연결하는 라우터 유형
  > 백본 네트워크는 소형 네트워크들을 묶어 대규모 파이프라인을 통해 극도로 높은 대역폭으로 다른 네트워크들의 집합과 연결되는 네트워크
  > 다양한 네트워크를 상호 연결하는 컴퓨터 네트워크의 일부
  > 네트워크의 중심에 백본이 위치하여 모든 패킷이 지나간다.

- 아이피 맥(MAC) 포워딩
  이더넷 네트워크에서, HTTP메시지는 주소가 붙은 데이터 패킷의 형태로 보내짐
  패킷은 출발지와 목적지의 IP주소와 TCP포트번호로 이루어진 레이어-4(응용계층)주소를 갖고 있음
  MAC 주소 포워딩은 점 대 점(point to point(물리적 연결))으로만 가능하기 때문에, 서버나 프락시는 스위치와 한 홉 거리에 위치해야 함
  > 홉(hop)은 컴퓨터 네트워크에서 출발지와 목적지 사이에 위치한 경로의 한 부분

- IP 주소 포워딩
  패킷에 대해 TCP/IP 어드레싱을 검증하고 패킷을 목적지 아이피 주소의 변경에 따라 라우팅
  목적지 서버가 한 홉 거리에 있을 필요 없이 그저 스위치에서 업스트림의 위치를 판별할 수만 있으면 됨
  스위치에서 업스트림의 위치를 판별할 수 있으면 일반적인 레이어-3 (end-to-end) 인터넷 라우팅이 패킷을 올바른 위치로 전송 -> NAT(네트워크 주소 변환)
  클라이언트로부터 들어오는 TCP 커넥션을 받아오는 스위치(L4)는 커넥션을 관리 -> 스위치는 관리하는 커넥션을 통해 클라이언트에게 응답을 돌려줘야함


프락시와 캐시 리다이렉션 기법
프락시로 향하는 리다이렉트 트래픽에 대해서만 사용할 수 있음
프락시는 클라요청을 다른 프락시로 리다이렉트 할 수 있음

- 명시적인 브라우저 설정
  프락시 이름, IP주소, 포트번호 설정할 수 있는 풀다운 메뉴가 존재
  미리 설정이 다 되어 있는 브라우저는 접촉할 프락시의 주소를 안다. 
  - 설정된 프락시가 응답하지 않더라도, 브라우저는 원서버에 접촉하지 않음 -> 프락시 다운되면 브라우저 다운
  - 네트워크 아키텍쳐 변경했을 경우 모든 최종사용자에게 변경사항을 전달하는 것이 어려움
- 프락시 자동설정
  PAC(프락시 자동 설정)은 브라우저들이 URL별로 접촉해야 할 프락시를 지정한 PAC파일이라는 파일을 찾도록 하는 것

- 웹 프락시 자동발견 프로토콜(WPAD)
  사용자가 프락시 설정 & 트래픽 인터셉트에 의존할 필요 없이 웹브라우저가 근처의 프락시를 찾아내어 사용할 수 있게 해주는 방법
  - PAC 파일 자동발견 : WPAD는 HTTP 클라이언트가 PAC파일 위치를 찾아 실행
  - WPAC의 알고리즘 : 적절한 PAC파일 CURL을 결정하기 위한 알고리즘
  - DHCP를 이용한 CURL 발견 : DHCP 서버가 CURL을 저장하여 WPAD가 CURL을 얻는다.
  - DNS A 레코드 룩업 : DNS 서버에 프락시 서버의 IP주소들을 저장하여 CURL을 얻는다.

- 웹 캐시 조직 프로토콜(WCCP)
  웹 캐시서버의 존재와 동작유무를 확인하여 문제가 없으면 사용자의 웹요청을 프록시서버로 리다이렉트 하는 것
  WCCP를 지원하는 라우터들은 HTTP 패킷을 특정 서버의 IP 주소와 함께 _캡슐화(GRE)_ 함으로써 특정 서버로 리다이렉트 함

- 인터넷 캐시 프로토콜(ICP)
  캐시가 서로 통신할 수 있는 객체 위치 프로토콜, 일종의 캐시 클러스터링 프로토콜이라고 할 수 있음
  한 차례 이상의 ICP를 통해 HTTP 요청 메시지의 최종 목적지를 결정하는 점에서 리다이렉션 프로토콜이다.

- 캐시 배열 라우팅 프로토콜(CARP)
  캐시 서버들 사이에 트래픽을 공유함으로써 캐쉬간 통신 데이터양 감소, 다수의 캐쉬가 존재할 경우 client의 요청에 대해 빠른 정보를 제공하기 위한 프로토콜
  hash-base의 라우팅을 사용하며 캐쉬 array를 사용하여, 사전에 정의된 _request resolution path_ 를 사용한다. 
  > _request resolution path_ 란 array member identity와 URL을 사용하여 hashing에 기초하며, URL 요청을 받았을 경우, 최초의 요청 또는 캐쉬 array의 어느 부분에 저장되어있는지를 알 수 있음을 의미함........

  - _request resolution path_ 를 사용하여 single-hop resolution 을 수행 -> 캐쉬 서버간의 쿼리메세지가 없다.
  - ICP 경우 쿼리메세지를 이용하기에 서버 수가 많으면 혼잡발생
  - 캐쉬이름과 URL에 대한 hash table 을 가짐
  - array에서 서버/변경/삭제가 용이하여 서버들을 효울적으로 관리
  - 중복 보유가 없음

- 하이퍼텍스트 캐싱 프로토콜(HTCP)
  

으.... 어렵다 
리다이렉트가 이렇게 광범위 한 것이었다니 
모르는 용어가 종종 나와서 블로그 계속 찾아보면서 봤는데 
물리계층까지 넘어갈 줄 어떻게 알았냐 ( 은근 재밌기는 함 )
네트워크 따로 한번 보면 좋을 듯 하다.



[네트워크](https://togll.tistory.com/42)
[kakao의 Anycast 활용 사례](https://tech.kakao.com/2014/05/29/anycast/#:~:text=Anycast%20%EB%9E%80%20%EC%9A%A9%EC%96%B4%EB%8A%94%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC,%EA%B0%80%EC%A7%88%20%EC%88%98%20%EC%9E%88%EB%8A%94%20%EA%B0%9C%EB%85%90%EC%9E%85%EB%8B%88%EB%8B%A4.)
[[네트워크] OSI 7계층 - 네트워크 장비, 스위치 종류](https://velog.io/@kimyeji203/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-OSI-7%EA%B3%84%EC%B8%B5-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%9E%A5%EB%B9%84-%EC%8A%A4%EC%9C%84%EC%B9%98-%EC%A2%85%EB%A5%98)
[웹캐싱](https://withbundo.blogspot.com/2017/09/http-27-http-web-caching-ii.html)
[CARP](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=wind1237&logNo=220713404913)
