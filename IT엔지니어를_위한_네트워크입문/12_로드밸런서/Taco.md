서비스를 이중화할 때, 복잡한 고려없이 이중화를 손쉽게 구현하도록 로드밸런서가 많이 사용된다.

이는 다양한 구성 방식과 동작모드를 가지고 있어서, 이를 이해해야 서비스에 필요한 구성을 할 수 있다.
로드밸런서를 구성하는 기본 개념에 대해 알아야한다.

## 부하 분산
서비스 가용성을 높이기 위해, 하나의 서비스는 보통 두 대 이상의 서버로 구성하는데 
각 서버 IP가 다르기에, 만약 하나의 서버에 장애가 발생한다고 한다면 서비스 장애로 이어질 수 있다.

이를 위해 로드밸런서를 사용한다. 서비스 요청을 분산시켜 부하를 분산한다. 

## 부하 분산 방법
LACP의 방식과 유사하게, 가상 IP 주소를 갖게 된다. 이는 VIP라고도 한다.
가상 IP 주소가 있다면, 실제 IP도 있는데, 이를 리얼 IP라고 하고, 가상 IP에 이들이 바인딩된다. 
사용자가 VIP 로 서비스를 요청하면 해당 VIP에 연결된 리얼 IP로 해당 요청을 전달한다. 

로드 밸런서에서 부하 분산을 위한 그룹을 만들 때는, 4계층 정보인 서비스 포트까지 지정해 만듭니다. 
그래서 로드 밸런서를 L4 스위치라고도 한다. 
그러나, 서비스 포트와 실제 서버의 서비스 포트는 같을 필요가 없다. 로드밸런서에서 다 바꿔줄 수 있다.

## 헬스 체크
로드밸런서는, 다양한 방식으로 서버의 헬스체크를 해서 정상적으로 작동하는 서비스 쪽으로 부하를 분산한다. 

1) ICMP
VIP에 연결된 리얼 서버로 헬스체크 수행. 살아있는지 단순 체크만 하는거라 잘 안 쓴다.

2) TCP 서비스 포트
가장 기본적인 헬스 체크 방법. 서버의 서비스 포트를 확인

3) TCP 서비스 포트 : half open
일반적으로는 서비스 포트 확인시 SYN/SYN, ACK/ACK까지 3핸드셰이크를 거치는데, 
더 빨리 하기 위해서 절반 개방을 한다. 
SYN > SYN, ACK > ACK 대신 RST 보냄

4) HTTP 상태 코드
포트까지는 열리지만 응답을 정상적으로 해주지 못하는 경우가 있어서, HTTP 코드를 확인한다 *200OK 를 받아야함

5) 콘텐츠 확인 
4 이상으로 문자열 응답까지 확인, 대신 정상적인 요청 결괏값은 보장하지 않음.

- 헬스 체크를 하는 주기의 여러 타이머 값이 있다.


## 부하 분산 알고리즘
로드밸런서가 부하를 분산하는 여러 알고리즘이 있다.
제공되는 서비스의 특징을 잘 고려해 알고리즘을 결정해야 한다.

1) 라운드 로빈
특별한 규칙은 없고, 
현재 구성된 장비에 순차적으로 돌아가며 트래픽을 분산한다.

2) 최소 접속 방식
서버가 가진 세션 부하 확인해서 그에 맞게 분산
각 장비에 연결된 현 세션 수를 알 수 있다. 
가장 적게 연결된 장비로 서비스 요청을 보낸다.

3) 해시
서버 부하를 고려하지느 ㄴ않고,
클라이언트가 같은 서버에 지속적으로 접속하게 한다. 
출발지와 목적지 IP, 출발지와 목적지 서비스 포트로 알고리즘 계산에 사용되는 값을 지정한다.

각 서버에서 세션을 유지해야 하는 서비스에 유리하지만, 부하 분산 비율이 한쪽으로 치우쳐질 수 있다.

그래서 최소 접속 방식과 해시의 장점을 묶어 부하 분산하는 방법도 있다. (스티키)

## 구성 방식

로드 밸런서의 위치에 따라 달라진다.

1) 원암 구성
중간 위치의 스위치 옆에 연결되는 구성
서버로 들어가거나 나오는 트래픽이 꼭 로드밸런서를 경유하지 않을 수도 있다. 
부하 분산을 이용하는 트래픽일 경우 > 서버로 유입되는 트래픽은 로드밸런서를 거친다
부하분산을 이용하지 않을시 > 굳이 로드밸런서를 거치지 않아도 서버와 통신할 수 있다. 
그러므로 스위치와 로드밸런서 간의 대역폭을 최소화할 수 있고, 확장에 유리하다 (인라인 구성보다)


2) 인라인 구성
서버로 가는 경로 상에 연결되는 구성
트래픽이 흐르는 경로에 로드밸런서가 있어서, 모든 트래픽이 로드밸런서를 통과한다. 
구성이 직관적이고 이해하기 쉬우나, 로드밸런서의 부하가 높아진다.


핵심은 서버로 가는 트래픽이 <모두> 로드밸런서를 경유하는지 아닌지로 구분.

## 동작 모드
- 구성 방식과 관련있다.
- 동작 모드에 따라 패킷 통신 방식도 달라진다.

1) 트랜스패런트 모드
- 로드 밸런서가 2계층 스위치처럼 동작.
> VIP 주소와, 실제 서버가 동일한 네트워크를 사용, 이 경우 서비스 응답이 로드밸런서를 거치지 않을 수가 있다. (스위치 역할을 하게되므로)
- 기존 망의 트래픽 흐름에 미치는 영향 없이 로드밸런서를 손쉽게 구성할 수 있다.
- 원암과 인라인 모두 가능. 

2) 라우티드 모드
- 로드밸런서가 라우팅 역할을 하는 모드
- 원암, 인라인 모두 가능
- 서로 다른 네트워크를 로드 밸런서가 연결하는 것.
> 이 때문에, MAC 주소를 모두 바꾸게된다.

3) DSR(Direct Server Return)모드
- 사용자 요청 > 로드밸런서 > 서버로 요청이 가면, 서버 > 사용자로 바로 응답하는 모드
- 원암으로 구성
- L2 DSR, L3 DSR로 구성
- L2의 경우, 실제 서버의 네트워크를 로드밸런서가 가진 경우, L3은 아닌 경우
- 로드 밸런서 부하가 전반적으로 감소
- 서비스 응답이 로드밸런서를 경유하지 않아 문제 발생시 확인이 어렵다. 따라서 추가 설정이 필요하다. Source NAT을 수행하기 어렵기 때문이다.
- 실제 서버 IP로 응답을 받게된다. 이 경우 패킷을 처리하지않을 수 있으므로, 로드밸런서에서는 IP를 바꾸지않는다. 서버에서는 VIP 주소를 할당한다. 
- 서버에서는 루프백 인터페이스의 IP주소로 응답을 보낸다.
