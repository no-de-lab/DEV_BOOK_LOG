서비스를 이중화할 때, 복잡한 고려없이 이중화를 손쉽게 구현하도록 로드밸런서가 많이 사용된다.

이는 다양한 구성 방식과 동작모드를 가지고 있어서, 이를 이해해야 서비스에 필요한 구성을 할 수 있다.
로드밸런서를 구성하는 기본 개념에 대해 알아야한다.

## 부하 분산
서비스 가용성을 높이기 위해, 하나의 서비스는 보통 두 대 이상의 서버로 구성하는데 
각 서버 IP가 다르기에, 만약 하나의 서버에 장애가 발생한다고 한다면 서비스 장애로 이어질 수 있다.

이를 위해 로드밸런서를 사용한다. 서비스 요청을 분산시켜 부하를 분산한다. 

## 부하 분산 방법
LACP의 방식과 유사하게, 가상 IP 주소를 갖게 된다. 이는 VIP라고도 한다.
가상 IP 주소가 있다면, 실제 IP도 있는데, 이를 리얼 IP라고 하고, 가상 IP에 이들이 바인딩된다. 
사용자가 VIP 로 서비스를 요청하면 해당 VIP에 연결된 리얼 IP로 해당 요청을 전달한다. 

로드 밸런서에서 부하 분산을 위한 그룹을 만들 때는, 4계층 정보인 서비스 포트까지 지정해 만듭니다. 
그래서 로드 밸런서를 L4 스위치라고도 한다. 
그러나, 서비스 포트와 실제 서버의 서비스 포트는 같을 필요가 없다. 로드밸런서에서 다 바꿔줄 수 있다.

## 헬스 체크
로드밸런서는, 다양한 방식으로 서버의 헬스체크를 해서 정상적으로 작동하는 서비스 쪽으로 부하를 분산한다. 

1) ICMP
VIP에 연결된 리얼 서버로 헬스체크 수행. 살아있는지 단순 체크만 하는거라 잘 안 쓴다.

2) TCP 서비스 포트
가장 기본적인 헬스 체크 방법. 서버의 서비스 포트를 확인

3) TCP 서비스 포트 : half open
일반적으로는 서비스 포트 확인시 SYN/SYN, ACK/ACK까지 3핸드셰이크를 거치는데, 
더 빨리 하기 위해서 절반 개방을 한다. 
SYN > SYN, ACK > ACK 대신 RST 보냄

4) HTTP 상태 코드
포트까지는 열리지만 응답을 정상적으로 해주지 못하는 경우가 있어서, HTTP 코드를 확인한다 *200OK 를 받아야함

5) 콘텐츠 확인 
4 이상으로 문자열 응답까지 확인, 대신 정상적인 요청 결괏값은 보장하지 않음.

- 헬스 체크를 하는 주기의 여러 타이머 값이 있다.


## 부하 분산 알고리즘
로드밸런서가 부하를 분산하는 여러 알고리즘이 있다.
제공되는 서비스의 특징을 잘 고려해 알고리즘을 결정해야 한다.

1) 라운드 로빈
특별한 규칙은 없고, 
현재 구성된 장비에 순차적으로 돌아가며 트래픽을 분산한다.

2) 최소 접속 방식
서버가 가진 세션 부하 확인해서 그에 맞게 분산
각 장비에 연결된 현 세션 수를 알 수 있다. 
가장 적게 연결된 장비로 서비스 요청을 보낸다.

3) 해시
서버 부하를 고려하지느 ㄴ않고,
클라이언트가 같은 서버에 지속적으로 접속하게 한다. 
출발지와 목적지 IP, 출발지와 목적지 서비스 포트로 알고리즘 계산에 사용되는 값을 지정한다.

각 서버에서 세션을 유지해야 하는 서비스에 유리하지만, 부하 분산 비율이 한쪽으로 치우쳐질 수 있다.

그래서 최소 접속 방식과 해시의 장점을 묶어 부하 분산하는 방법도 있다. (스티키)
