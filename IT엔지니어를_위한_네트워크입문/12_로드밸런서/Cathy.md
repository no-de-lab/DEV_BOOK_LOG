# 12장 로드밸런서
동일한 서비스를 하는 다수의 서버가 등록되고 사용자로 부터 서비스 요청이 오면 로드 밸런서가 받아 사용자 별로 다수의 서버에 서비스 요청을 분산시켜 부하를 분산
대규모 서비스 제공을 위해 로드 밸런서는 필수 서비스 
L4 L7스위치라는 로드 밸런서 사용



부하를 다수의 장비로 어떻게 분산할까? 
다수의 장비에 분산시키기 위해 가상 IP 주소를 갖게 됨
VIP(가상 IP) 또는 서비스 IP주소라고 함 

가상이 있다면 실제가 있다 -> 로드 밸런서의 가상 IP에 실제 서버들이 바인딩 된다.

> 실무에서 가상은 VIP 실제(비인딩 되어있는 서버)는 리얼 IP 또는 RIP 부름


- 구성 방식
로드 밸런서의 구성 위치에 따라 2가지로 나눌 수 있음

원암 One Arm (마치 한 쪽 팔을 벌린 형태의 구성과 같아 -_-;;;)
  로드 밸런서가 스위치 옆에 있는 형태 
  트래픽이 로드 밸런서를 경유하거나 경유하지 않을 수 있음 
  트래픽이 로드 밸런서를 경유하는지 여부는 부하 분산을 이용한 트래픽인지 여부로 구분
  
  장점
    불필요한 트래픽이 로드 밸런서에 유입되지 않아 로드 밸런서 부하를 줄일 수 있음 
    스위치와 로드 밸러서 간의 대역폭을 최소화 할 수 있고 부족할 경우 그 구간만 증성할 수 있어서 인라인 방식보다 상대적으로 확장에 유리
    로드 밸런서에 장애가 발생에도 일반 트래픽 흐름에는 영향을 미치지 않음

인라인 Inline
  로드 밸런서가 스위치에서 서버까지 일직선상 경로에 있는 형태 
  모든 트래픽이 로드 밸런서를 통과 
  원암에 비해 로드 밸런서의 부하가 상대적으로 높음 
  주의 밸런싱 성능과 패킷 스루풋 성능을 구별해 디자인해야함 


- 동작 모드
트랜스 패런트 또는 브릿지 모드
  로드 밸런서가 OSI 2계층 스위치처럼 동작하는 구성
  VIP주소와 실제 서버가 동일한 네트워크를 사용하는 구성 
  원암 One Arm 과 인라인 Inline 구성에서 모두 사용할 수 있는 모드
  다만 원암 구성에서는 응답 트래픽 경로 부분이 문제가 될 수 있어 Source NAT가 필요
  장점
    로드 밸런서 도입으로 인한 IP네트워크 재설계를 고려하지 않아도 됨
    기존 망의 트래픽 흐름에 미치는 여향 없이 로드 밸런서를 손쉽게 구성

라우티드 Routed 모드
  로드 밸런서가 라우팅 역할을 수행하는 모드 
  로드 밸런서 기준으로 사용자 / 서버 방향이 서로 다른 네트워크로 분리된 구성
  보안 강화목적으로 서버쪽 네트워크를 사설로 구성해 직접 접속하는 것을 막는 용도로 사용되기도 함

  원암 One Arm 과 인라인 Inline 구성에서 모두 사용할 수 있는 모드

DSR(Direct Server Return) 모드
  사용자의 요청이 로드 밸런서를 통해 서버로 유입된 후에 다시 로드 밸런서를 통하지 않고 서버가 사용자에게 직접 응답하는 모드
  사용자가 요청하는 패킷에 대해서만 관여
  DSR 모드는 응답할 때, 로드 밸런서를 경유하지 않으므로 _원암_ 으로 구성
  다른 모드와 달리 추가 설정 필요 (-> 잘 몰겠음 다시 읽어보기)
    루프백 인터페이스 설정
    리눅스 커널 파라미터 수정(리눅스) / 네트워크 설정 변경(윈도)
  
  구분
    L2 DSR 실제 서버의 네트워크를 로드 밸런서가 가진 경우 (로드 밸런서 통신이 L2 통신)
    L3 DSR 실제 서버의 네트워크 대역을 로드 밸런서가 가지지 않은 경우 (로드 밸런서 통신이 L3 통신)

  장점
  요청 트래픽에만 로드 밸런서를 통함으로 로드 밸런서 부하가 감소 
  일반적으로 응답 패킷의 크기가 더 크기 때문에 밸런서 부하가 감소에 효과적
  단점
  응답이 로드 밸런서 경유하지 않으므로 문제가 발생했을 때 확인이 어렵다.
  
- 유의사항

원암 구성의 동일 네트워크 사용시
  게이트웨이를 로드 밸런서로 설정
  Source NAT 사용
  DSR 모드

동일 네트워크 내에서 서비스 IP 호출

## 헬스체크 
로드 밸런서에서는 부하 분산을 하는 각 서버의 서비스를 주기적으로 헬스 체크해 정상적인 서비스 쪽으로만 부하를 분산
비 정상적인 서버는 서비스 그룹에서 제외해 트래픽을 보내지 않음. 
제외된 후에도 헬스체크를 수행하여 정상으로 확인되면 서비스 그룹에 다시 넣어 트래픽 서버 쪽으로 보내지도록 함 

- 핼스 체크 방식
  - ICMP
    VIP에 연결된 리얼 서버에 대해 ICMP(Ping)로 헬스 체크를 수행하는 방법
    단순히 서버가 살아 있는지 여부만 체크하여 잘 사용하지 않음
  - TCP 서비스 포트
    기본적인 헬스 체크 방법으로 서버의 서비스 포트를 확인 (핸드쉐이크)
  - TCP 서비스 포트: Half Open
    헬스 체크로 인한 부하를 줄이거나 정상적인 종료 방식보다 빨리 헬스 체크 세션을 끊기 위해 기존 
    3방향 핸드셰이크에서 ACK 대신 RST를 보내 세션을 끊는 방식
  - HTTP 상태 코드
    200 OK 응답하는지 여부를 체크
  - 콘텐츠 확인(문자열 확인)
    서버로 컨텐츠 요청하고 응답 받은 내용을 확인하여 헬스 체크하는 방식
    주의 : 확인하려는 문자열만 확인되면 에러코드에도 정상으로 확인되므로 정상 코드 값도 중복으로 확인 필요

- 주기와 타이머
헬스 체크의 주요 고려 사항 
  - 주기
    로드 밸런서에서 서버로 헬스 체크 패킷을 보내는 주기
  - 응답시간
    헬스 체크 패킷을 보내고 응답을 기다리는 시간
    해당 시간짜기 응답이 오지 않으면 실패
  - 시도 횟수
    헬스 체크 시도 횟수
    최대 시도 횟수 이전에 성공시 시도 횟수 초기화
  - 타임아웃
    헬스 체크 실패시 최대 대기 시간
    헬스 체크 패킷을 서버로 전송한 후 이 시간 내에 성공하지 못하면 해당 서버는 다운
  - 서비스 다운 시의 주기
    서비스 다운 시의 헬스 체크 주기
    서비스가 죽은 상태에서 헬스 체크 주기를 별도로 더 늘릴 때 사용 

## 부하 분산 알고리즘

- (*)라운드 로빈
  라운드 로빈 알고리즘은 일반적으로 기본 로드 밸런싱 설정이며 클러스터내의 Server 를 순회하면서 서비스합니다. 
  즉 클러스터에 A, B, C 서버가 있을 경우 A → B → C → A 식으로 순회하여 부하를 분산
  처리 서버가 바뀔수 있으므로 이 방식을 사용하려면 session clustering 이 구성되어 있어야함
  서버간 처리 용량이 다른 경우 적합하지 않음
- (*)최소 접속 방식
  가장 클라이언트 연결 갯수가 적은 서버로 부하를 분산하여 균등하게 전달하는 방식
  RR 과 마찬가지로 이 방식을 사용하려면 session clustering 이 구성
- 가중치 기반 라운드 로빈
- 가중치 기반 최소 접속 방식
- (*)해시
  클라이언트 IP 를 hash(알고리즘에 의한 계산 값) 해서 특정 클라이언트는 특정 서버로 연결하도록 하는 설정
  세션을 유지해야 하는 서비스에 적합한 분산 방식
  그러나 알고리즘이 특정한 값으로 치우치면 부하 분산 비율이 한쪽으로 치우칠 수 있는 단점이 있음 
- 해시 + 최소 접속 방식(스티키 옵션)
  최소 접속 방식을 사용하면서 _스티키 옵션_ 을 주어 한번 접속한 커넥션을 지속적으류 유지하는 기법
  처음 요청을 세션 테이블에 두고 같은 요청이 들어오면 같은 장비로 분산해 세션 유지
  > 세션 테이블에는 타임아웃이 있어서 그 이후에는 분산되는 장비가 달라질 수 있다는 것을 고려해야함
  > 사용자의 행동패턴을 충분히 감안하여 사용해야함

[로드밸런서 개념 특징](https://m.post.naver.com/viewer/postView.naver?volumeNo=27046347&memberNo=2521903)
  







