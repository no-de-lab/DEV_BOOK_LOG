# 11장 이중화 기술
이중화 기술 기술은 서비스의 가용성을 높여주고 가용량을 확장해주기에 안정적인 서비스를 위해서는 필수


## 이중화가 없을 경우 문제점 

인프라 주요 목표 중 하나는 타임 투 마켓(time to market)을 위한 _민첩성_ 이다.

인프라를 설계할 , _가용성, 연속성, 안정성_ 등 의 항목이 서비스를 안정적으로 제공하는데 필요한 주요 지표이다.

따라서 인프라 구축 할 때 
시스템 구성 요소 중 동작하지 않으면 전체 시스템이 중단되는 요소(SPoF)를 만들지 말아야한다.

## 이중화의 목적
안정적인 서비스 제공
복수 개 이상의 인프라를 구성해 특정 인프라에 문제가 발생하더라도 이중화된 다른 인프라를 통해 서비스 지속
때문에 서비스에 필요한 End to End에 속하는 모든 인프라에 이중화 구성을 고려해야함

이중화 구성이 필요한 항목들
- 물리적 또난 가상 머신 서버
- 서버와 네트워크 장비를 구성해주는 인터페이스 
- 서버에 연결된 스위치
- 다수 서버의 부하 분산을 위한 L4/L7 스위치, 
- 방화벽, 
- 인터켓 게이트웨이, 
- 인터넷 회선 등등 ......
- 위의 요소가 속한 데이터 센터(DR 센터 또는 액티브-액티브 데이터 센터 구축)

이중화 구성을 동시에 운영 중인 상태(액티브-액티브)로 동작 대기 상태(액티브-스탠바이)로 형태로 구성
ex) 스위치의 스패닝 트리 프로토콜은 가용한 링크를 루프 방지를 위해 액티브-스탠바이 형태로 구성된 이중화 기술

장애가 없다면 굳이 이중화 하지 않아도 되지만 왜 해야하는가? 특정 인프라에서 장애가 생겨도 서비스의 연속성이 보장된다. 이것을 _폴트 톨러런스(Fault Tolerance)_ 가 보장된다고 함

> 액티브-액티브 경우에는 장비간 네트워크 연결이나 회선의 대역폭이 증가함. 용량을 산정할 때 한 인프라가 다른 인프라의 대역폭도 감당 할 수 있어야 한다. 


## 이중화 기술
### LACP(액티브-액티브)
이중화 장비들 간의 상호 호환 가능한 연결 계층 표준화
여러개의 물리적 포트들을 묶어서 하나의 논리적인 포트로 동작하게 만드는 기술
이것을 통해 스위치와 스위치 또는 스위치와 서버 간 네트워크 대역폭이 물리 인터페이스 수량만큼 확장됨

액티브-액티브 상태이기에 지연없이 서비스 제공
서버에서 본딩이나 타밍과 같은 이중화 구성을 할 때, 두 개의 물리 MAC주소 중 하나를 Primary MAC주소로 사용

- 주의할 점
LACP로 구성하는 논리 인터페이스의 대역폭을 서비스에 필요한 전체 트래픽 기준으로 서비스 트래픽을 산정하면 안됨
대역폭이 2G라고해서 A,B 논리 인터페이스의 대역폭을 각 1G로 산정하면 안됨, B에 문제 발생했을 경우, A가 전체를 감당하지 못함

- 동작방식
LACP 구성을 위해 출발지 & 목적지 주소, 타입, 서브 타입, 버전 정도 등 LACPDU 프레임을 사용하여 매초마다 주고 받음
LACPDU는 멀티캐스트를 이용
LACP가 연결되려면 한 LACPDU안에서 정보를 주고 받아야함. (상호간 구성이 1:1 이어야 함)
서로 다른 LACPDU에 연결 되어 있으면 LACP를 통한 링크 이중화 구성을 할 수 없음


- LACP 설정 모드 
액티브: LACPDU를 먼저 송신하고 상대방이 LACP로 구성된 경우에 LACP를 구성(보통방식)
패시브: LACPDU를 송신하지 않지만 LACPDU를 수신받으면 응답해서 LACP를 구성
* 양 단 장비 모드 패시브일 경우 서로 LACPDU를 먼저 보내지 않으므로 정상적으로 LACP연결이 안됨



(LACP)[https://ja-gamma.tistory.com/entry/LACP%EA%B0%9C%EB%85%90%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC]




### MC-LAG or MLAG 
서로 다른 스위치 간의 실제 MAC주소 대신 가상 MAC주소를 만들어 논리 인터페이스로 LACP를 구성하는 기술 

- MC-LAG 구성요소 
피어장비: MC-LAG 구성하는 장비
MC-LAG 도메인: 두 피어 장비를 하나의 논리 장비로 구성하기 위한 영역 ID, 피어장비는 이 영역 ID를 통해 상대방 확인
피어 링크: MC-LAG를 구성하는 두 피어 장비 간의 데이터 트래픽을 전송하는 인터링크 

- 구성하는 방법 
각 피어에 동일한 도메인 ID 값 설정
피어간 데이터 트래픽을 전송하기 윈한 피어 링크 구성(네트워크가 통신할 수 있는 경로이므로 트렁크로 구성)
제어 패킷을 위한 경로 구성 (두 가지 경우로 구성가능)
  피어링크를 이용한 제어 패킷 전송
  별도의 인터페이스로 제어 패킷 전송 


- 동작방식
설정이 끝나면 두 피어 장비는 MC-LAG를 맺기 위한 제어 패킷을 주고 받음
협상이 완료되면 두 장비는 하나의 MC-LAG 도메인으로 묶임
인터페이스 이중화 구성에 사용할 가상 MAC 주소를 피어 장비 간에 동일하게 생성
두 피어간 MC-LAG을 마치면 MC-LAG 피어 장비들은 다른 장비와 LACP를 구성 할 수 있음


## 게이트 이중화
호스트/서버들은 인터넷과 같은 외부 네트워크로 패켓을 전송할 때 게이트웨이를 이용하여 전송함
하지만 게이트웨이가 고장난다면? 그래서 이중화를 해서 하나가 고장나도 나머지 하나로 대체한다는 개념(자동으로 다른 라우터나 스위치가 게이트역할)


- FHRP
게이트웨이 이중화 프로토콜 (FHRP:First Hop Redundancy Protocols)
FHRP는 다수의 라우터를 하나의 Group으로 묶어서 우회경로를 제공하여 서비스의 연속성을 가능하게함

(FHRP)[https://gakari.tistory.com/entry/%EB%AC%B8-FHRPFirst-Hop-Redundancy-Protocol]



시스코, IBM, 알카텔-루슨트...