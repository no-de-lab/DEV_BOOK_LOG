# 7장 통신을 도와주는 네트워크 주요 기술

IP 네트워크에 통신을 도와주는 주요기술(다양한 서비스와 프로토콜)을 알아보는 장

주요 기술
- NAT
  - 하나의 IP를 사용해 여러 단말 정비를 포함하는 네크워크를 손쉽게 구축하는 기술
- DNS
  - 도메인 이름과 IP 주소를 매핑하는 서비스
- GSLB
  - 가장 가까운 지역의 데이터 센터에 접속해 신속한 서비스를 받게 해주는 기술
- DHCP
  - IP 주소를 자동으로 할당하는 기술 


## NAT(Network Address Translation)
네트워크 주소를 변환하는 기술
기본적으로는 1:1 변환이지만, IP 주소가 고갈되는 문제를 해결하기 위해 1:N ip로 변환(PAT) 하기도 함
보통 사설 IP -> 공인 IP 주소로 전환하는데 많이 사용된다. 

### NAT/PAT 용도와 필요성
- IPv4 주소 고갈문제의 솔루션
  - 주소 보전 전략 단기 서브네팅, 중기 NAT 와 사설ip 장기 IPv6 전환
  - 그 중 NAT기술이 큰 역할을 함
  - 외부 공개에는 공인 ip, 일반 사용자 사설 ip를 이용하여 효율적으로 ip를 사용 할 수 있게 됨
- 보안 강화
  - 사내IP 주소 체계를 숨김으로써 보안 강화
  - 통신을 위해 ip 주소 변환/역변환을 해야 통신 가능
  - 외부에서 들어오는 통신을 방어하여 보안 강화
- 더블 나트 : IP 주소 체계가 같은 두 개의 네트워크 간의 통신 가능
  - 공인 ip 주소는 유일하기에 괜찮으나 사설 경우에는 ip가 중복 될 수 있음 
  - ex) 대외계 - 카드사, 은행 간 연결하는 네트워크 
  - 출발지, 도착지를 한꺼번에 변환하는 더블나트 기술로 ip 충돌 방지
- 불필요한 설정 변경을 줄임

그 외 단점
주소가 변환되면서 단말 간 직접적인 연결성이 무너짐
NAT 환경을 항상 고려하면서 개발해야함 (ex : WebRTC)

### NAT 동작방식
- NAT 기본 동작
  변경된 공인 ip을 패킷에 수정하여 전송/수신함
  - 사용자가 보낸 패킷을 수신한 후 NAT 정책에 따라 통신가능한 공인ip 로 주소 변경하고 변경 전후의 ip를 NAT 테이블에 저장
  - 패킷의 출발지 주소를 변경된 ip주소로 웹서버 전송
  - 서버에서 응답 받은 목적지 주소가 NAT 테이블에 출발지 주소와 매칭을 확인
  - 주소가 확인 된 패킷은 원래 주소로 출발지가 변경되어 최종적으로 수신 됨
- PAT
  - NAT 기본 동작과 비슷하고 변경 방식을 PAT로 동작하여, ip & 포트를 변경한다.
  - 만약 서비스 포트가 모두 사용 중인 경우 제대로 동작하지 않음
  - 이러할 경우 공인 ip 주소를 하나가 아닌 풀(Pool)로 구성해야함
  - pat ip가 목적지일때는 기존 ip를 확인할 수 테이블이 없으므로 SNAT에서만 적용됨
- SNAT와 DNAT
  NAT를 사용해 주소를 변환할 때 어떤 주소를 변환하는지에 따라 두 가지로 구분
  SNAT와 DNAT의 기준은 NAT가 수행되기 이전의 트래픽이 출발하는 시작 시점
  - SNAT (출발지 주소 변경)
    - 사설에서 공인으로 통산할때 주로 사용됨 (공유기처럼 사용됨)
    - 보안상으로 사용됨 
    - 로드밸런서 구성에 따라 snat 사용하기도 함
  - DNAT (도착지 주소 변경)
    - 로드밸서에서 많이 사용됨
    - 12 장에서 자세히 나옴
- 동적 NAT 와 정적 NAT
  - 출발지, 목적지의 ip를 미리 매핑해 고정해 놓은 NAT를 정적 NAT, 그 반대가 정적 NAT
  - 동적 경우 다수의 ip 풀에서 정해지므로 최소한 출발지나 목적지 한 곳이 ip풀이나 range를 설정되어 있다
  - 동적은 수행하는 시점에 nat 테이블일 만들어지고통신이 없으면 사라진다(nat 테이블 타임아웃)

## DNS
네트워크 통신 관계를 맺거나 유지하는 컨트롤 프로토콜 중 하나
도메인 주소를 IP 주소로 변환하는 역할
최근 클라우드 기반 인프가 구성이 많아지면서 dns 설계가 중요해지고 있다.

### DNS구조
Third.Second.Top.(Root)
> 루트 도메인 전 서계에 13개 인데 죄다 미쿡에 몰려 있음 -_-;
### DNS동작방식
도메인을 IP 주소로 변환하려면 DNS서버에 도메인 쿼리하는 과정을 거쳐야함 
-> 과거는 hosts.txt 파일로 주소를 관리했다...캄

** 재귀적 쿼리 와 반복적 쿼리
  - 재귀적 쿼리 서버가 최종 결괏값을 반환하는 서버 중심 쿼리 (클라 - 로컬 DNS 간에 사용)
  - 반복적 쿼리 최종값을 받을 때 까지 클라에서 쿼리를 계속 진행하는 방식 (로컬 DNS 서버와 상위 DNS 구간에 사용)

### 마스터와 슬레이브 
DNS 서버는 마스터 / 슬레이브 서버로 나눠진다
도메인에 대한 존(Zone) 파일을 직접 과리하는지 여부로 구분
마스터 - 존 파일을 직접 생성해 도메인 관련 정보를 관리
슬레이브 - 마스터에 만들어진 존 파일을 (정기적)복제 -> 이 과정을 영역 전송이라고 함
DNS 서버는 이중화에서 일반적으로 사용하는 액티브-스탠바이 or 액티브-액티브 형태로 구성하지 않음 
-> 때문에 마스터 서버에 에러가 발생하면 슬레이브 서버를 마스터로 변환 또는
-> 만료 시간 안에 마스터 서버를 복구해야함
> 마스터? 슬레이브? 네이밍이ㅎㅎ PC때문에 바뀔 가능성 있을까낭

## GSLB
DNS 역활 + 도메인에 연결된 서비스가 정상적인지 헬스 체크를 함으로써
DNS가 도메인을 이용해 로드밸런싱 구현하는데 도움을 줌

GSLB를 이용해 서비스를 분산하면,
- 서비스 제공 가능 여부를 체크해 트래픽 분산
- 지리적으로 멀리 떨어진 다른 데이터 센터에 트래픽 분산
- 지역적으로 가까운 서비스에 접속해 빠른 서비스 제공 하능하도록 분산


### GSLB 구성방식
- 도메인 자체를 GSLB로 사용
  - 모든 레코드 설정을 GSLB 장비에서 관리
  - GSLB 자체가 도메인의 네임 서버 역학을 함
  - 불필요한 경우에도 레코드에 대한 질의가 모두 GSLB를 통해 이루어지므로 GSLB 부하를 주게된다.
- 도메인 내의 특정 레코드만 GSLB로 사용
  - 별칭 사용 (CNAME)
  - 위임 사용 (NS)

## DHCP
Dynamic Host Configuration Protocol
대부분의 가정용 네트워크에서는 라우터가 IP 주소를 장치에 할당하는 DHCP 서버의 역할을 한다.
DHCP는 네트워크 관리자가 해야 할 작업을 간소화
> vpn에서 주로 사용

DHCP 장점
- 동일한 IP 주소를 이용하는 두 명의 사용자 사이의 _충돌 방지_
- DHCP는 _높은 이동성_ 을 보장하며 사용자는 네트워크 범위 내에서 어디서든지 모바일 장치를 이용
- 별도의 IP 할당 서버가 필요하지 않아 _네트워크 관리 효율성이 개선_

DHCP 동작방식 
discover > offer > request > ask
ip를 할당 받는 과정을 임대 과정이라고 함, 
임대 시간이 있기에 같은 과정을 반복하기 싫다면 갱신을 해야함 
갱신은 임대 시간의 50%가 지나면 갱신할 수 있고, 갱신을 실패하면 75% 지난 시점에 다시 갱신 시도함 (2번의 갱신 시도)
그 마저도 실패하면 처음부터 다시 시작하여 ip 할당 받아야함 
- discover: DHCP 클라에서 DHCP서버를 찾기위해 discover 메세지를 브로트캐스트로 전송
  - 클라에 ip가 없으므로 유니캐스트가 아닌 브로드 캐스트로 전송 
  - TCP가 아닌 UDP를 사용
- offer : DHCP 서버가 클라에게 할당할 ip주소, 서브넷, 게이트 웨이등 정보를 포함한 DHCP 메세지를 클라에 전송
- request: 서버로 부터 제안받은 IP주소, DHCP 서버 정보를 포함한 DHCP 요청 메시지를 클라에서 전송
- ask: 서버가 메세지 정상적으로 받았다는 수신





